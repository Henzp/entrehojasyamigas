<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Entre Hojas y Amigas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-leaf"></i> Entre Hojas y Amigas</h2>
            <p>Panel de Administración</p>
        </div>
        
        <div class="sidebar-menu">
            <div class="menu-section">
                <div class="menu-section-title">Principal</div>
                <button class="menu-item active" onclick="showPage('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
                <button class="menu-item" onclick="showPage('productos')">
                    <i class="fas fa-seedling"></i> Gestionar Productos
                </button>
                <button class="menu-item" onclick="showPage('nuevo-producto')">
                    <i class="fas fa-plus-circle"></i> Nuevo Producto
                </button>
                <button class="menu-item" onclick="showPage('banner')">
                    <i class="fas fa-images"></i> Banner Principal
                </button>
                <button class="menu-item" onclick="showPage('tips')">
                    <i class="fas fa-lightbulb"></i> Gestionar Tips
                </button>
                <button class="menu-item" onclick="showPage('nuevo-tip')">
                    <i class="fas fa-plus-circle"></i> Nuevo Tip
                </button>
            </div>
            
            <div class="menu-section">
                <div class="menu-section-title">Sistema</div>
                <a href="/" class="menu-item">
                    <i class="fas fa-store"></i> Ver Tienda
                </a>
                <button class="menu-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 id="pageTitle">Dashboard</h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">A</div>
                    <span>Administrador</span>
                </div>
                <button class="btn-logout" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </header>

        <!-- Content -->
        <main class="content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="page-section active">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-seedling"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalProductos">0</div>
                        <div class="stat-label">Total Productos</div>
                    </div>
                    
                    <div class="stat-card info">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="productosActivos">0</div>
                        <div class="stat-label">Productos Activos</div>
                    </div>
                    
                    <div class="stat-card warning">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-images"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalBanners">0</div>
                        <div class="stat-label">Banners Activos</div>
                    </div>
                    
                    <div class="stat-card danger">
                        <div class="stat-header">
                            <div class="stat-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalTips">0</div>
                        <div class="stat-label">Tips de Cuidado</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Productos Recientes</h3>
                        <button class="btn btn-primary" onclick="showPage('nuevo-producto')">
                            <i class="fas fa-plus"></i> Nuevo Producto
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="productosRecientes">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando productos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gestionar Productos Section -->
            <section id="productos" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-seedling"></i> Lista de Productos</h3>
                        <button class="btn btn-primary" onclick="showPage('nuevo-producto')">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="productosContainer">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando productos...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Nuevo/Editar Producto Section -->
            <section id="nuevo-producto" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-plus-circle"></i> <span id="productoFormTitle">Nuevo Producto</span></h3>
                        <button class="btn btn-secondary" onclick="showPage('productos')">
                            <i class="fas fa-arrow-left"></i> Volver
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="productoForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="nombre">Nombre del Producto *</label>
                                    <input type="text" id="nombre" class="form-control" required placeholder="Nombre del producto">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="categoria">Categoría *</label>
                                    <select id="categoria" class="form-control" required>
                                        <option value="">Seleccionar categoría</option>
                                        <option value="Interior">Interior</option>
                                        <option value="Exterior">Exterior</option>
                                        <option value="Pet Friendly">Pet Friendly</option>
                                        <option value="Fácil Cuidado">Fácil Cuidado</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="precio">Precio *</label>
                                    <input type="number" id="precio" class="form-control" required min="0" step="1" placeholder="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="precioOriginal">Precio Original (opcional)</label>
                                    <input type="number" id="precioOriginal" class="form-control" min="0" step="1" placeholder="Para mostrar descuento">
                                </div>
                                
                                <div class="form-group full-width">
                                    <label class="form-label" for="descripcion">Descripción *</label>
                                    <textarea id="descripcion" class="form-control" rows="4" required placeholder="Descripción del producto"></textarea>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label class="form-label">Imágenes del Producto *</label>
                                    
                                    <div class="image-upload-tabs">
                                        <button type="button" class="upload-tab active" onclick="switchUploadTab('files')">
                                            <i class="fas fa-upload"></i> Subir Archivo
                                        </button>
                                        <button type="button" class="upload-tab" onclick="switchUploadTab('urls')">
                                            <i class="fas fa-link"></i> Agregar por URL
                                        </button>
                                    </div>
                                    
                                    <!-- Subir archivos -->
                                    <div id="files-content" class="upload-content active">
                                        <div class="file-upload-section" 
                                             ondrop="handleDrop(event)" 
                                             ondragover="handleDragOver(event)" 
                                             ondragenter="handleDragEnter(event)" 
                                             ondragleave="handleDragLeave(event)">
                                            <div class="upload-icon">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                            </div>
                                            <h4>Arrastra y suelta imágenes aquí</h4>
                                            <p>o haz clic para seleccionar archivos</p>
                                            <small>PNG, JPG, JPEG - Máximo 5MB por imagen</small>
                                            <input type="file" id="imageUpload" multiple accept="image/*" onchange="handleFileSelect(event)" style="display: none;">
                                        </div>
                                    </div>
                                    
                                    <!-- Agregar por URL -->
                                    <div id="urls-content" class="upload-content">
                                        <div class="url-input-group">
                                            <input type="url" id="imageUrl" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                                            <button type="button" class="btn btn-primary btn-add-url" onclick="agregarImagenPorUrl()">
                                                <i class="fas fa-plus"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview de imágenes -->
                                    <div id="imagesPreview" class="images-preview"></div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" class="btn btn-secondary" onclick="showPage('productos')">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button type="submit" class="btn btn-success" id="btnGuardarProducto">
                                    <i class="fas fa-save"></i> Guardar Producto
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Banner Section -->
            <section id="banner" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-images"></i> Gestión del Banner Principal</h3>
                        <button class="btn btn-primary" onclick="mostrarFormularioBanner()">
                            <i class="fas fa-plus"></i> Agregar Imagen
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="bannerList">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando banner...</p>
                            </div>
                        </div>
                        
                        <!-- Formulario para agregar banner -->
                        <div id="bannerForm" style="display: none;">
                            <h4>Agregar Nueva Imagen al Banner</h4>
                            <form onsubmit="guardarBanner(event)">
                                <div class="form-group">
                                    <label class="form-label">URL de la Imagen *</label>
                                    <input type="url" id="bannerImageUrl" class="form-control" required placeholder="https://ejemplo.com/imagen.jpg">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Texto Alternativo *</label>
                                    <input type="text" id="bannerAlt" class="form-control" required placeholder="Descripción de la imagen">
                                </div>
                                
                                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                                    <button type="button" class="btn btn-secondary" onclick="ocultarFormularioBanner()">
                                        <i class="fas fa-times"></i> Cancelar
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tips Section -->
            <section id="tips" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-lightbulb"></i> Gestión de Tips</h3>
                        <button class="btn btn-primary" onclick="showPage('nuevo-tip')">
                            <i class="fas fa-plus"></i> Agregar Tip
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="tipsContainer">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Cargando tips...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Nuevo/Editar Tip Section -->
            <section id="nuevo-tip" class="page-section">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-plus-circle"></i> <span id="tipFormTitle">Nuevo Tip</span></h3>
                        <button class="btn btn-secondary" onclick="showPage('tips')">
                            <i class="fas fa-arrow-left"></i> Volver
                        </button>
                    </div>
                    <div class="card-body">
                        <form id="tipForm">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label" for="tipTitulo">Título del Tip *</label>
                                    <input type="text" id="tipTitulo" class="form-control" required placeholder="Título del tip">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="tipCategoria">Categoría *</label>
                                    <select id="tipCategoria" class="form-control" required>
                                        <option value="">Seleccionar categoría</option>
                                        <option value="Riego">Riego</option>
                                        <option value="Luz">Luz</option>
                                        <option value="Fertilización">Fertilización</option>
                                        <option value="Poda">Poda</option>
                                        <option value="Plagas">Plagas</option>
                                        <option value="Trasplante">Trasplante</option>
                                        <option value="General">General</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="tipDificultad">Dificultad *</label>
                                    <select id="tipDificultad" class="form-control" required>
                                        <option value="">Seleccionar dificultad</option>
                                        <option value="Principiante">Principiante</option>
                                        <option value="Intermedio">Intermedio</option>
                                        <option value="Avanzado">Avanzado</option>
                                    </select>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label class="form-label" for="tipDescripcionCorta">Descripción Corta *</label>
                                    <textarea id="tipDescripcionCorta" class="form-control" rows="3" required 
                                              placeholder="Resumen breve del tip (máximo 200 caracteres)"></textarea>
                                    <small>Máximo 200 caracteres - aparece en la tarjeta del tip</small>
                                </div>
                                
                                <div class="form-group full-width">
                                    <label class="form-label" for="tipDescripcionCompleta">Descripción Completa *</label>
                                    <textarea id="tipDescripcionCompleta" class="form-control" rows="5" required 
                                              placeholder="Explicación detallada del tip que aparecerá en el modal"></textarea>
                                    <small>Explicación completa que se mostrará cuando el usuario haga clic en "Ver Completo"</small>
                                </div>
                                
                                <!-- Sistema de imágenes para tips -->
                                <div class="form-group full-width">
                                    <label class="form-label">Imagen del Tip *</label>
                                    
                                    <div class="image-upload-tabs">
                                        <button type="button" class="upload-tab active" onclick="switchTipUploadTab('tip-files')">
                                            <i class="fas fa-upload"></i> Subir Archivo
                                        </button>
                                        <button type="button" class="upload-tab" onclick="switchTipUploadTab('tip-urls')">
                                            <i class="fas fa-link"></i> Agregar por URL
                                        </button>
                                    </div>
                                    
                                    <!-- Subir archivos -->
                                    <div id="tip-files-content" class="upload-content active">
                                        <div class="file-upload-section" 
                                             ondrop="handleTipDrop(event)" 
                                             ondragover="handleDragOver(event)" 
                                             ondragenter="handleDragEnter(event)" 
                                             ondragleave="handleDragLeave(event)">
                                            <div class="upload-icon">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                            </div>
                                            <h4>Arrastra y suelta una imagen aquí</h4>
                                            <p>o haz clic para seleccionar archivo</p>
                                            <small>PNG, JPG, JPEG - Máximo 5MB</small>
                                            <input type="file" id="tipImageUpload" accept="image/*" onchange="handleTipFileSelect(event)" style="display: none;">
                                        </div>
                                    </div>
                                    
                                    <!-- Agregar por URL -->
                                    <div id="tip-urls-content" class="upload-content">
                                        <div class="url-input-group">
                                            <input type="url" id="tipImageUrl" class="form-control" placeholder="https://ejemplo.com/imagen.jpg">
                                            <button type="button" class="btn btn-primary btn-add-url" onclick="agregarTipImagenPorUrl()">
                                                <i class="fas fa-plus"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Preview de imagen del tip -->
                                    <div id="tipImagePreview" class="images-preview"></div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" class="btn btn-secondary" onclick="showPage('tips')">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                                <button type="submit" class="btn btn-success" id="btnGuardarTip">
                                    <i class="fas fa-save"></i> Guardar Tip
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal de Confirmación -->
    <div id="confirmModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3>Confirmar Acción</h3>
                <button class="modal-close" onclick="cerrarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button class="btn btn-danger" id="confirmBtn">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        let productos = [];
        let imagenesSeleccionadas = [];
        let productoEditando = null;
        let bannerItems = [];
        let bannerImagenSeleccionada = '';
        let tipsData = [];
        let tipImagenSeleccionada = '';
        let tipEditando = null;

        // Inicializar al cargar
        document.addEventListener('DOMContentLoaded', function() {
            cargarProductos();
            cargarBanner();
            cargarTipsAdmin();
        });

        // ===============================================
        // NAVEGACIÓN
        // ===============================================
        function showPage(pageId, fromEdit = false) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(pageId).classList.add('active');
            
            if (typeof event !== 'undefined' && event && event.target) {
                event.target.classList.add('active');
            } else {
                const menuCorrect = document.querySelector(`[onclick="showPage('${pageId}')"]`);
                if (menuCorrect) {
                    menuCorrect.classList.add('active');
                }
            }
            
            const titles = {
                'dashboard': 'Dashboard',
                'productos': 'Gestionar Productos',
                'nuevo-producto': fromEdit ? 'Editar Producto' : 'Nuevo Producto',
                'banner': 'Banner Principal',
                'tips': 'Gestionar Tips',
                'nuevo-tip': fromEdit ? 'Editar Tip' : 'Nuevo Tip'
            };
            
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.textContent = titles[pageId] || 'Dashboard';
            }
            
            if (pageId === 'nuevo-producto' && !fromEdit) {
                limpiarFormulario();
            }
            
            if (pageId === 'nuevo-tip' && !fromEdit) {
                limpiarFormularioTip();
            }
            
            if (pageId === 'banner') {
                cargarBanner();
            }

            if (pageId === 'tips') {
                cargarTipsAdmin();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function logout() {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                fetch('/api/auth/logout', { method: 'POST' })
                    .then(() => {
                        window.location.href = '/login';
                    })
                    .catch(error => {
                        console.error('Error cerrando sesión:', error);
                        window.location.href = '/login';
                    });
            }
        }

        // ===============================================
        // FUNCIONES PARA PRODUCTOS
        // ===============================================
        async function cargarProductos() {
            try {
                const response = await fetch('/api/productos');
                productos = await response.json();
                mostrarProductos();
                actualizarEstadisticas();
                mostrarProductosRecientes();
            } catch (error) {
                console.error('Error cargando productos:', error);
                document.getElementById('productosContainer').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error cargando productos</h3>
                        <p>Hubo un problema al cargar los productos</p>
                        <button class="btn btn-primary" onclick="cargarProductos()">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    </div>
                `;
            }
        }

        function mostrarProductos() {
            const container = document.getElementById('productosContainer');
            
            if (productos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-seedling"></i>
                        <h3>No hay productos registrados</h3>
                        <p>Comienza agregando tu primer producto</p>
                        <button class="btn btn-primary" onclick="showPage('nuevo-producto')">
                            <i class="fas fa-plus"></i> Agregar Primer Producto
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${productos.map(producto => `
                                <tr>
                                    <td>
                                        <img src="${producto.imagenes[0] || 'https://via.placeholder.com/60x60'}" 
                                             alt="${producto.nombre}" 
                                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                    </td>
                                    <td>${producto.nombre}</td>
                                    <td>${producto.categoria}</td>
                                    <td>$${producto.precio.toLocaleString()}</td>
                                    <td>
                                        <span class="status-badge ${producto.activo ? 'success' : 'danger'}">
                                            ${producto.activo ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                    <td class="actions">
                                        <button class="btn btn-info btn-small" onclick="editarProducto('${producto._id}')" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-warning btn-small" onclick="toggleProductoEstado('${producto._id}')" title="${producto.activo ? 'Desactivar' : 'Activar'}">
                                            <i class="fas fa-${producto.activo ? 'eye-slash' : 'eye'}"></i>
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="confirmarEliminarProducto('${producto._id}', '${producto.nombre}')" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function mostrarProductosRecientes() {
            const container = document.getElementById('productosRecientes');
            const recientes = productos.slice(0, 5);
            
            if (recientes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-seedling"></i>
                        <p>No hay productos registrados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th>Precio</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recientes.map(producto => `
                                <tr>
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <img src="${producto.imagenes[0] || 'https://via.placeholder.com/40x40'}" 
                                                 alt="${producto.nombre}" 
                                                 style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px;">
                                            <span>${producto.nombre}</span>
                                        </div>
                                    </td>
                                    <td>${producto.categoria}</td>
                                    <td>$${producto.precio.toLocaleString()}</td>
                                    <td>
                                        <span class="status-badge ${producto.activo ? 'success' : 'danger'}">
                                            ${producto.activo ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function actualizarEstadisticas() {
            document.getElementById('totalProductos').textContent = productos.length;
            document.getElementById('productosActivos').textContent = productos.filter(p => p.activo).length;
        }

        // ===============================================
        // GESTIÓN DE IMÁGENES PARA PRODUCTOS
        // ===============================================
        function switchUploadTab(tab) {
            document.querySelectorAll('.upload-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.upload-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.upload-tab[onclick="switchUploadTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-content`).classList.add('active');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.closest('.file-upload-section').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.target.closest('.file-upload-section').classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.closest('.file-upload-section').classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            procesarArchivos(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            procesarArchivos(files);
        }

        // Hacer clickeable la zona de drag and drop
        document.addEventListener('click', function(e) {
            if (e.target.closest('.file-upload-section')) {
                document.getElementById('imageUpload').click();
            }
        });

        async function procesarArchivos(files) {
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    if (file.size <= 5 * 1024 * 1024) { // 5MB
                        try {
                            const imageUrl = await subirImagen(file);
                            if (imageUrl) {
                                imagenesSeleccionadas.push(imageUrl);
                                actualizarPreviewImagenes();
                            }
                        } catch (error) {
                            console.error('Error subiendo imagen:', error);
                            alert('Error subiendo la imagen: ' + file.name);
                        }
                    } else {
                        alert(`La imagen ${file.name} es muy grande (máximo 5MB)`);
                    }
                }
            }
        }

        async function subirImagen(file) {
            const formData = new FormData();
            formData.append('image', file);
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.url;
                } else {
                    throw new Error('Error en la respuesta del servidor');
                }
            } catch (error) {
                console.error('Error subiendo imagen:', error);
                throw error;
            }
        }

        function agregarImagenPorUrl() {
            const url = document.getElementById('imageUrl').value.trim();
            if (url) {
                imagenesSeleccionadas.push(url);
                document.getElementById('imageUrl').value = '';
                actualizarPreviewImagenes();
            }
        }

        function actualizarPreviewImagenes() {
            const preview = document.getElementById('imagesPreview');
            preview.innerHTML = imagenesSeleccionadas.map((url, index) => `
                <div class="image-item">
                    <img src="${url}" alt="Imagen ${index + 1}" onerror="this.src='https://via.placeholder.com/150?text=Error'">
                    <button type="button" class="image-remove" onclick="eliminarImagen(${index})" title="Eliminar imagen">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function eliminarImagen(index) {
            imagenesSeleccionadas.splice(index, 1);
            actualizarPreviewImagenes();
        }

        // ===============================================
        // FORMULARIO DE PRODUCTOS
        // ===============================================
        function limpiarFormulario() {
            document.getElementById('productoForm').reset();
            imagenesSeleccionadas = [];
            productoEditando = null;
            actualizarPreviewImagenes();
            document.getElementById('productoFormTitle').textContent = 'Nuevo Producto';
            document.getElementById('btnGuardarProducto').innerHTML = '<i class="fas fa-save"></i> Guardar Producto';
        }

        document.getElementById('productoForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (imagenesSeleccionadas.length === 0) {
                alert('Debes agregar al menos una imagen');
                return;
            }
            
            const formData = {
                nombre: document.getElementById('nombre').value.trim(),
                categoria: document.getElementById('categoria').value,
                precio: parseInt(document.getElementById('precio').value),
                precioOriginal: document.getElementById('precioOriginal').value ? parseInt(document.getElementById('precioOriginal').value) : null,
                descripcion: document.getElementById('descripcion').value.trim(),
                imagenes: imagenesSeleccionadas,
                activo: true
            };
            
            try {
                const url = productoEditando ? `/api/productos/${productoEditando}` : '/api/productos';
                const method = productoEditando ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert(productoEditando ? 'Producto actualizado correctamente' : 'Producto creado correctamente');
                    await cargarProductos();
                    showPage('productos');
                } else {
                    throw new Error('Error al guardar el producto');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el producto');
            }
        });

        async function editarProducto(id) {
            const producto = productos.find(p => p._id === id);
            if (!producto) return;
            
            productoEditando = id;
            
            document.getElementById('nombre').value = producto.nombre;
            document.getElementById('categoria').value = producto.categoria;
            document.getElementById('precio').value = producto.precio;
            document.getElementById('precioOriginal').value = producto.precioOriginal || '';
            document.getElementById('descripcion').value = producto.descripcion;
            
            imagenesSeleccionadas = [...producto.imagenes];
            actualizarPreviewImagenes();
            
            document.getElementById('productoFormTitle').textContent = 'Editar Producto';
            document.getElementById('btnGuardarProducto').innerHTML = '<i class="fas fa-save"></i> Actualizar Producto';
            
            showPage('nuevo-producto', true);
        }

        async function toggleProductoEstado(id) {
            const producto = productos.find(p => p._id === id);
            if (!producto) return;
            
            try {
                const response = await fetch(`/api/productos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...producto,
                        activo: !producto.activo
                    })
                });
                
                if (response.ok) {
                    await cargarProductos();
                } else {
                    throw new Error('Error al cambiar estado del producto');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cambiar estado del producto');
            }
        }

        function confirmarEliminarProducto(id, nombre) {
            mostrarModalConfirmacion(
                `¿Estás seguro de que quieres eliminar el producto "${nombre}"?`,
                () => eliminarProducto(id)
            );
        }

        async function eliminarProducto(id) {
            try {
                const response = await fetch(`/api/productos/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await cargarProductos();
                    cerrarModal();
                } else {
                    throw new Error('Error al eliminar el producto');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el producto');
            }
        }

        // ===============================================
        // FUNCIONES PARA BANNER
        // ===============================================
        async function cargarBanner() {
            try {
                const response = await fetch('/api/banners');
                const banner = await response.json();
                bannerItems = banner;
                mostrarBanner(banner);
                actualizarEstadisticasBanner();
            } catch (error) {
                console.error('Error cargando banner:', error);
                const bannerList = document.getElementById('bannerList');
                if (bannerList) {
                    bannerList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Error cargando banner</h3>
                            <p>Hubo un problema al cargar las imágenes del banner</p>
                        </div>
                    `;
                }
            }
        }

        function mostrarBanner(banner) {
            const bannerList = document.getElementById('bannerList');
            if (!bannerList) return;
            
            if (banner.length === 0) {
                bannerList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-images"></i>
                        <h3>No hay imágenes en el banner</h3>
                        <p>Agrega la primera imagen para comenzar</p>
                        <button class="btn btn-primary" onclick="mostrarFormularioBanner()">
                            <i class="fas fa-plus"></i> Agregar Primera Imagen
                        </button>
                    </div>
                `;
                return;
            }

            bannerList.innerHTML = banner.map(item => `
                <div class="banner-item" data-id="${item._id}">
                    <div class="banner-item-header">
                        <div class="banner-orden">Orden ${item.orden}</div>
                        <div class="banner-actions">
                            <button class="btn btn-small btn-secondary banner-drag-handle" title="Arrastar para reordenar">
                                <i class="fas fa-grip-vertical"></i>
                            </button>
                            <button class="btn btn-small btn-danger" onclick="confirmarEliminarBanner('${item._id}', '${item.alt}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="banner-content">
                        <div>
                            <img src="${item.imagen}" alt="${item.alt}" class="banner-image-preview" 
                                 onerror="this.src='https://via.placeholder.com/300x200?text=Error+Cargando'">
                        </div>
                        <div class="banner-form">
                            <div class="form-group">
                                <label class="form-label">URL de la Imagen</label>
                                <input type="text" class="form-control" value="${item.imagen}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Texto Alternativo</label>
                                <input type="text" class="form-control" value="${item.alt}" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <span class="status-badge ${item.activo ? 'success' : 'danger'}">
                                    ${item.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function actualizarEstadisticasBanner() {
            document.getElementById('totalBanners').textContent = bannerItems.filter(b => b.activo).length;
        }

        function mostrarFormularioBanner() {
            document.getElementById('bannerForm').style.display = 'block';
        }

        function ocultarFormularioBanner() {
            document.getElementById('bannerForm').style.display = 'none';
            document.getElementById('bannerImageUrl').value = '';
            document.getElementById('bannerAlt').value = '';
        }

        function guardarBanner(e) {
            e.preventDefault();
            
            const imagen = document.getElementById('bannerImageUrl').value.trim();
            const alt = document.getElementById('bannerAlt').value.trim();
            
            if (!imagen || !alt) {
                alert('Todos los campos son obligatorios');
                return;
            }
            
            const bannerData = {
                imagen: imagen,
                alt: alt,
                orden: bannerItems.length + 1,
                activo: true
            };
            
            fetch('/api/banners', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bannerData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    cargarBanner();
                    ocultarFormularioBanner();
                } else {
                    alert('Error al guardar el banner');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al guardar el banner');
            });
        }

        function confirmarEliminarBanner(id, alt) {
            mostrarModalConfirmacion(
                `¿Estás seguro de que quieres eliminar la imagen "${alt}"?`,
                () => eliminarBanner(id)
            );
        }

        async function eliminarBanner(id) {
            try {
                const response = await fetch(`/api/banners/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await cargarBanner();
                    cerrarModal();
                } else {
                    throw new Error('Error al eliminar el banner');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el banner');
            }
        }

        // ===============================================
        // FUNCIONES PARA TIPS
        // ===============================================
        async function cargarTipsAdmin() {
            const tipsContainer = document.getElementById('tipsContainer');
            
            if (tipsContainer) {
                tipsContainer.innerHTML = `<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Cargando tips...</p></div>`;
            }
            
            try {
                const response = await fetch('/api/tips');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const tips = await response.json();
                tipsData = Array.isArray(tips) ? tips : [];
                mostrarTipsAdmin();
                actualizarEstadisticasTips();
            } catch (error) {
                console.error('Error cargando tips:', error);
                if (tipsContainer) {
                    tipsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Error cargando tips</h3>
                            <p>Hubo un problema al cargar los tips</p>
                            <button class="btn btn-primary" onclick="cargarTipsAdmin()">
                                <i class="fas fa-redo"></i> Reintentar
                            </button>
                        </div>
                    `;
                }
            }
        }

        function mostrarTipsAdmin() {
            const container = document.getElementById('tipsContainer');
            
            if (tipsData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-lightbulb"></i>
                        <h3>No hay tips registrados</h3>
                        <p>Comienza agregando tu primer tip de cuidado</p>
                        <button class="btn btn-primary" onclick="showPage('nuevo-tip')">
                            <i class="fas fa-plus"></i> Agregar Primer Tip
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Título</th>
                                <th>Categoría</th>
                                <th>Dificultad</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tipsData.map(tip => `
                                <tr>
                                    <td>
                                        <img src="${tip.imagen || 'https://via.placeholder.com/60x60'}" 
                                             alt="${tip.titulo}" 
                                             style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                    </td>
                                    <td>${tip.titulo}</td>
                                    <td>${tip.categoria}</td>
                                    <td>
                                        <span class="difficulty-badge ${tip.dificultad.toLowerCase()}">
                                            ${tip.dificultad}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="status-badge ${tip.activo ? 'success' : 'danger'}">
                                            ${tip.activo ? 'Activo' : 'Inactivo'}
                                        </span>
                                    </td>
                                    <td class="actions">
                                        <button class="btn btn-info btn-small" onclick="editarTip('${tip._id}')" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-warning btn-small" onclick="toggleTipEstado('${tip._id}')" title="${tip.activo ? 'Desactivar' : 'Activar'}">
                                            <i class="fas fa-${tip.activo ? 'eye-slash' : 'eye'}"></i>
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="confirmarEliminarTip('${tip._id}', '${tip.titulo}')" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function actualizarEstadisticasTips() {
            document.getElementById('totalTips').textContent = tipsData.filter(t => t.activo).length;
        }

        // ===============================================
        // GESTIÓN DE IMÁGENES PARA TIPS
        // ===============================================
        function switchTipUploadTab(tab) {
            document.querySelectorAll('.upload-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.upload-content').forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.upload-tab[onclick="switchTipUploadTab('${tab}')"]`).classList.add('active');
            document.getElementById(`${tab}-content`).classList.add('active');
        }

        function handleTipDrop(e) {
            e.preventDefault();
            e.target.closest('.file-upload-section').classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                procesarArchivoTip(files[0]);
            }
        }

        function handleTipFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                procesarArchivoTip(file);
            }
        }

        // Hacer clickeable la zona de drag and drop para tips
        document.addEventListener('click', function(e) {
            if (e.target.closest('#tip-files-content .file-upload-section')) {
                document.getElementById('tipImageUpload').click();
            }
        });

        async function procesarArchivoTip(file) {
            if (file.type.startsWith('image/')) {
                if (file.size <= 5 * 1024 * 1024) { // 5MB
                    try {
                        const imageUrl = await subirImagen(file);
                        if (imageUrl) {
                            tipImagenSeleccionada = imageUrl;
                            actualizarPreviewImagenTip();
                        }
                    } catch (error) {
                        console.error('Error subiendo imagen:', error);
                        alert('Error subiendo la imagen');
                    }
                } else {
                    alert('La imagen es muy grande (máximo 5MB)');
                }
            }
        }

        function agregarTipImagenPorUrl() {
            const url = document.getElementById('tipImageUrl').value.trim();
            if (url) {
                tipImagenSeleccionada = url;
                document.getElementById('tipImageUrl').value = '';
                actualizarPreviewImagenTip();
            }
        }

        function actualizarPreviewImagenTip() {
            const preview = document.getElementById('tipImagePreview');
            if (tipImagenSeleccionada) {
                preview.innerHTML = `
                    <div class="image-item">
                        <img src="${tipImagenSeleccionada}" alt="Imagen del tip" onerror="this.src='https://via.placeholder.com/150?text=Error'">
                        <button type="button" class="image-remove" onclick="eliminarImagenTip()" title="Eliminar imagen">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            } else {
                preview.innerHTML = '';
            }
        }

        function eliminarImagenTip() {
            tipImagenSeleccionada = '';
            actualizarPreviewImagenTip();
        }

        // ===============================================
        // FORMULARIO DE TIPS
        // ===============================================
        function limpiarFormularioTip() {
            document.getElementById('tipForm').reset();
            tipImagenSeleccionada = '';
            tipEditando = null;
            actualizarPreviewImagenTip();
            document.getElementById('tipFormTitle').textContent = 'Nuevo Tip';
            document.getElementById('btnGuardarTip').innerHTML = '<i class="fas fa-save"></i> Guardar Tip';
        }

        document.getElementById('tipForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!tipImagenSeleccionada) {
                alert('Debes agregar una imagen para el tip');
                return;
            }
            
            const formData = {
                titulo: document.getElementById('tipTitulo').value.trim(),
                categoria: document.getElementById('tipCategoria').value,
                dificultad: document.getElementById('tipDificultad').value,
                descripcionCorta: document.getElementById('tipDescripcionCorta').value.trim(),
                descripcionCompleta: document.getElementById('tipDescripcionCompleta').value.trim(),
                imagen: tipImagenSeleccionada,
                activo: true
            };
            
            try {
                const url = tipEditando ? `/api/tips/${tipEditando}` : '/api/tips';
                const method = tipEditando ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    alert(tipEditando ? 'Tip actualizado correctamente' : 'Tip creado correctamente');
                    await cargarTipsAdmin();
                    showPage('tips');
                } else {
                    throw new Error('Error al guardar el tip');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al guardar el tip');
            }
        });

        async function editarTip(id) {
            const tip = tipsData.find(t => t._id === id);
            if (!tip) return;
            
            tipEditando = id;
            
            document.getElementById('tipTitulo').value = tip.titulo;
            document.getElementById('tipCategoria').value = tip.categoria;
            document.getElementById('tipDificultad').value = tip.dificultad;
            document.getElementById('tipDescripcionCorta').value = tip.descripcionCorta;
            document.getElementById('tipDescripcionCompleta').value = tip.descripcionCompleta;
            
            tipImagenSeleccionada = tip.imagen;
            actualizarPreviewImagenTip();
            
            document.getElementById('tipFormTitle').textContent = 'Editar Tip';
            document.getElementById('btnGuardarTip').innerHTML = '<i class="fas fa-save"></i> Actualizar Tip';
            
            showPage('nuevo-tip', true);
        }

        async function toggleTipEstado(id) {
            const tip = tipsData.find(t => t._id === id);
            if (!tip) return;
            
            try {
                const response = await fetch(`/api/tips/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...tip,
                        activo: !tip.activo
                    })
                });
                
                if (response.ok) {
                    await cargarTipsAdmin();
                } else {
                    throw new Error('Error al cambiar estado del tip');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cambiar estado del tip');
            }
        }

        function confirmarEliminarTip(id, titulo) {
            mostrarModalConfirmacion(
                `¿Estás seguro de que quieres eliminar el tip "${titulo}"?`,
                () => eliminarTip(id)
            );
        }

        async function eliminarTip(id) {
            try {
                const response = await fetch(`/api/tips/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await cargarTipsAdmin();
                    cerrarModal();
                } else {
                    throw new Error('Error al eliminar el tip');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar el tip');
            }
        }

        // ===============================================
        // MODAL DE CONFIRMACIÓN
        // ===============================================
        function mostrarModalConfirmacion(mensaje, callback) {
            document.getElementById('confirmMessage').textContent = mensaje;
            document.getElementById('confirmBtn').onclick = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('confirmModal').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });
    </script>
</body>
</html>