<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌱 Entre Hojas y Amigas - Plantas de interior y exterior a domicilio</title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/index.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="container">
                <div class="logo-container">
                    <div class="logo">
                        <img src="/images/logo-entre-hojas-amigas.png" alt="Entre Hojas y Amigas" class="logo-img">
                        <h1>🌿 Entre Hojas y Amigas</h1>
                    </div>
                    
                    <div class="nav-actions">
                        <button class="search-btn"><i class="fas fa-search"></i></button>
                        <button class="cart-btn" onclick="toggleCarrito()">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-count" id="cartCount">0</span>
                        </button>
                        
                        <div id="userActions" class="user-actions-container">
                            <span class="loading-user">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Section -->
        <nav class="navbar">
            <div class="container">
                <ul class="nav-menu">
                    <li><a href="#inicio">Inicio</a></li>
                    <li class="dropdown">
                        <a href="#productos">Plantas <i class="fas fa-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="#" data-categoria="Interior">Interior</a></li>
                            <li><a href="#" data-categoria="Exterior">Exterior</a></li>
                            <li><a href="#" data-categoria="Pet Friendly">Pet Friendly</a></li>
                            <li><a href="#" data-categoria="Fácil Cuidado">Fácil Cuidado</a></li>
                        </ul>
                    </li>
                    <li><a href="/tips">Tips</a></li>
                    <li><a href="#contacto">Contacto</a></li>
                </ul>
                
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="inicio">
        <div class="hero-content">
            <h1>Plantas de interior y exterior a domicilio</h1>
            <p>Encuentra una gran variedad de plantas de interior y exterior a domicilio. Elige la tuya con macetero autorregante, te asesoramos en el cuidado de las plantas.</p>
            <button class="cta-button" onclick="document.getElementById('productos').scrollIntoView()">
                Ver Plantas
            </button>
        </div>
        <div class="hero-image">
            <img src="https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=800" alt="Plantas hermosas">
        </div>
    </section>

    <!-- Categorías destacadas -->
    <section class="categorias-destacadas">
        <div class="container">
            <h2>Colecciones destacadas</h2>
            <div class="categorias-grid">
                <div class="categoria-card" data-categoria="Interior Grande">
                    <img src="https://images.unsplash.com/photo-1493606278519-11aa9a6b8453?w=400" alt="Plantas Grandes">
                    <div class="categoria-overlay">
                        <h3>Plantas Grandes</h3>
                        <p>Plantas de interior sobre 1 metro</p>
                        <button class="ver-mas">Ver más</button>
                    </div>
                </div>
                
                <div class="categoria-card" data-categoria="Pet Friendly">
                    <img src="https://images.unsplash.com/photo-1544568100-847a948585b9?w=400" alt="Pet Friendly">
                    <div class="categoria-overlay">
                        <h3>Pet Friendly</h3>
                        <p>Plantas que puedes tener con mascotas</p>
                        <button class="ver-mas">Ver más</button>
                    </div>
                </div>
                
                <div class="categoria-card" data-categoria="Autorregante">
                    <img src="https://images.unsplash.com/photo-1485955900006-10f4d324d411?w=400" alt="Autorregantes">
                    <div class="categoria-overlay">
                        <h3>Autorregantes</h3>
                        <p>Maceteros Autorregantes</p>
                        <button class="ver-mas">Ver más</button>
                    </div>
                </div>
                
                <div class="categoria-card" data-categoria="Fácil Cuidado">
                    <img src="https://images.unsplash.com/photo-1509423350716-97f2360af8e4?w=400" alt="Fácil Cuidado">
                    <div class="categoria-overlay">
                        <h3>Fácil Cuidado</h3>
                        <p>Ideales para comenzar</p>
                        <button class="ver-más">Ver más</button>
                    </div>
                </div>
                
                <div class="categoria-card" data-categoria="Regalo">
                    <img src="https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400" alt="Para Regalo">
                    <div class="categoria-overlay">
                        <h3>Para Regalo</h3>
                        <p>Plantas con Macetero para regalo</p>
                        <button class="ver-mas">Ver más</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Productos -->
    <section class="productos-section" id="productos">
        <div class="container">
            <div class="section-header">
                <h2>Nuestras Plantas</h2>
                <div class="filtros">
                    <button class="filtro-btn active" data-categoria="todas">Todas</button>
                    <button class="filtro-btn" data-categoria="Interior">Interior</button>
                    <button class="filtro-btn" data-categoria="Exterior">Exterior</button>
                    <button class="filtro-btn" data-categoria="Pet Friendly">Pet Friendly</button>
                    <button class="filtro-btn" data-categoria="Fácil Cuidado">Fácil Cuidado</button>
                </div>
            </div>
            
            <div class="productos-grid" id="productosGrid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando plantas...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Misión -->
    <section class="mision">
        <div class="container">
            <div class="mision-content">
                <h2>Compartiendo una conexión especial con la naturaleza, entregando alegría, pero en macetas</h2>
            </div>
        </div>
    </section>

    <!-- Banner de Imágenes Animado -->
    <section class="banner-imagenes" id="bannerSection" style="display: none;">
        <div class="banner-container">
            <div class="banner-track" id="bannerTrack">
                <!-- Las imágenes se cargarán dinámicamente -->
            </div>
        </div>
    </section>

    <!-- Carrito Sidebar -->
    <div class="carrito-sidebar" id="carritoSidebar">
        <div class="carrito-header">
            <h3><i class="fas fa-shopping-cart"></i> Mi Carrito</h3>
            <button class="close-carrito" onclick="toggleCarrito()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="carrito-items" id="carritoItems">
            <div class="carrito-vacio">
                <i class="fas fa-leaf"></i>
                <p>Tu carrito está vacío</p>
                <small>¡Agrega algunas plantas hermosas!</small>
            </div>
        </div>
        <div class="carrito-footer">
            <div class="carrito-total">
                <strong>Total: $<span id="carritoTotal">0</span></strong>
            </div>
            <button class="btn-comprar-carrito" onclick="procesarCompra()">
                Procesar Compra
            </button>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleCarrito()"></div>

    <!-- Footer -->
    <footer class="footer" id="contacto">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>🌿 Entre Hojas y Amigas</h3>
                    <p>Tu tienda de plantas de confianza</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Contacto</h4>
                    <p><i class="fas fa-envelope"></i> contacto@entrehojas.cl</p>
                    <p><i class="fas fa-phone"></i> +56 9 1234 5678</p>
                    <p><i class="fas fa-map-marker-alt"></i> Santiago, Chile</p>
                </div>
                
                <div class="footer-section">
                    <h4>Horarios</h4>
                    <p>Lun - Vie: 9:00am - 19:00pm</p>
                    <p>Sábado: 10:00 - 16:00</p>
                    <p>Domingo: 10:30 - 16:00</p>
                </div>
                
                <div class="footer-section">
                    <h4>Categorías</h4>
                    <a href="#">Plantas de Interior</a>
                    <a href="#">Plantas de Exterior</a>
                    <a href="#">Maceteros</a>
                    <a href="#">Pet Friendly</a>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 Entre Hojas y Amigas. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>    

    <script>
        // DEBUG: Variable global para ver el estado
        let currentUserState = null;

        // Función mejorada para verificar estado de sesión
        async function updateUserButtons() {
            const userActionsContainer = document.getElementById('userActions');
            
            try {
                console.log('🔍 Verificando estado de sesión...');
                
                const response = await fetch('/api/session-status');
                console.log('📡 Respuesta del servidor:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const sessionData = await response.json();
                console.log('📊 Datos de sesión:', sessionData);
                
                currentUserState = sessionData;
                
                if (sessionData.isLoggedIn) {
                    if (sessionData.userType === 'admin') {
                        userActionsContainer.innerHTML = `
                            <span class="user-name-small">👑 ${sessionData.userName}</span>
                            <a href="/admin" class="admin-btn-small">
                                <i class="fas fa-cog"></i> Admin
                            </a>
                            <button class="logout-btn-small" onclick="logout()" title="Cerrar Sesión">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        `;
                        console.log('✅ UI actualizada para ADMIN');
                    } else {
                        userActionsContainer.innerHTML = `
                            <span class="user-name-small">👤 ${sessionData.userName}</span>
                            <a href="/perfil" class="user-profile-btn">
                                <i class="fas fa-user"></i> Mi Perfil
                            </a>
                            <button class="logout-btn-small" onclick="logout()" title="Cerrar Sesión">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        `;
                        console.log('✅ UI actualizada para USUARIO');
                    }
                } else {
                    userActionsContainer.innerHTML = `
                        <a href="/login" class="login-btn-small">
                            <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                        </a>
                    `;
                    console.log('✅ UI actualizada para NO LOGUEADO');
                }
                
            } catch (error) {
                console.error('❌ Error al verificar sesión:', error);
                
                userActionsContainer.innerHTML = `
                    <a href="/login" class="login-btn-small">
                        <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                    </a>
                `;
            }
        }

        // Función para cerrar sesión
        async function logout() {
            try {
                console.log('🚪 Cerrando sesión...');
                
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    console.log('✅ Sesión cerrada');
                    await updateUserButtons();
                    window.location.reload();
                } else {
                    console.error('❌ Error al cerrar sesión');
                }
            } catch (error) {
                console.error('❌ Error de red al cerrar sesión:', error);
            }
        }

        // Función de debugging
        function checkUserState() {
            console.log('🔍 Estado actual del usuario:', currentUserState);
            return currentUserState;
        }

        // Cargar banner dinámicamente
        async function cargarBannerDinamico() {
            try {
                const response = await fetch('/api/banner');
                const bannerItems = await response.json();
                
                if (bannerItems.length === 0) {
                    document.getElementById('bannerSection').style.display = 'none';
                    return;
                }
                
                document.getElementById('bannerSection').style.display = 'block';
                
                const bannerTrack = document.getElementById('bannerTrack');
                
                const imagenesHTML = bannerItems.map(item => `
                    <div class="banner-item">
                        <img src="${item.imagen}" 
                             alt="${item.alt}" 
                             onerror="this.src='https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=300&h=200&fit=crop'">
                    </div>
                `).join('');
                
                bannerTrack.innerHTML = imagenesHTML + imagenesHTML;
                
                console.log('✅ Banner cargado con', bannerItems.length, 'imágenes');
                
            } catch (error) {
                console.error('❌ Error cargando banner:', error);
                document.getElementById('bannerSection').style.display = 'none';
            }
        }

        // Cargar productos
        async function cargarProductos() {
            const productosGrid = document.getElementById('productosGrid');
            
            try {
                const response = await fetch('/api/productos');
                const productos = await response.json();
                
                if (productos.length === 0) {
                    productosGrid.innerHTML = `
                        <div class="no-productos">
                            <i class="fas fa-seedling"></i>
                            <h3>Próximamente nuevas plantas</h3>
                            <p>Estamos preparando un hermoso catálogo de plantas para ti</p>
                        </div>
                    `;
                    return;
                }
                
                productosGrid.innerHTML = productos.map(producto => {
                    const imagenes = producto.imagenes || [];
                    const imagenPrincipal = imagenes[0] || 'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400';
                    
                    let stockInfo = '';
                    if (producto.stock <= 0) {
                        stockInfo = '<div class="stock-indicator">Agotado</div>';
                    } else if (producto.stock <= 5) {
                        stockInfo = `<div class="stock-indicator low-stock">Últimas ${producto.stock}</div>`;
                    } else {
                        stockInfo = `<div class="stock-indicator">Stock: ${producto.stock}</div>`;
                    }
                    
                    return `
                        <div class="producto-card" data-categoria="${producto.categoria}">
                            <div class="producto-images" onclick="verProducto('${producto._id}')" title="Ver detalles de ${producto.nombre}">
                                <div class="categoria-badge">${producto.categoria}</div>
                                ${stockInfo}
                                
                                ${imagenes.map((imagen, index) => `
                                    <img src="${imagen}" 
                                         alt="${producto.nombre}" 
                                         class="producto-image ${index === 0 ? 'active' : ''}"
                                         onerror="this.src='https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400'">
                                `).join('')}
                                
                                ${imagenes.length > 1 ? `
                                    <div class="image-dots">
                                        ${imagenes.map((_, index) => `
                                            <span class="dot ${index === 0 ? 'active' : ''}" 
                                                  onclick="event.stopPropagation(); cambiarImagen(this, ${index})"
                                                  title="Imagen ${index + 1}"></span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="producto-info">
                                <div class="producto-content">
                                    <h3 class="producto-nombre" onclick="verProducto('${producto._id}')" title="Ver detalles de ${producto.nombre}">${producto.nombre}</h3>
                                    <p class="producto-descripcion">${producto.descripcion}</p>
                                    <div class="producto-precio">$${formatearPrecio(producto.precio)}</div>
                                </div>
                                
                                <div class="producto-botones">
                                    <button class="btn-agregar" onclick="agregarAlCarrito('${producto._id}')" ${producto.stock <= 0 ? 'disabled' : ''}>
                                        <i class="fas fa-cart-plus"></i> ${producto.stock <= 0 ? 'Agotado' : 'Agregar'}
                                    </button>
                                    <button class="btn-comprar" onclick="verProducto('${producto._id}')">
                                        <i class="fas fa-eye"></i> Ver más
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                configurarFiltros(productos);
                
            } catch (error) {
                console.error('Error cargando productos:', error);
                productosGrid.innerHTML = `
                    <div class="no-productos">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error al cargar productos</h3>
                        <p>Por favor, recarga la página</p>
                    </div>
                `;
            }
        }

        // Ir a la página del producto
        function verProducto(productoId) {
            console.log('🔍 Navegando a producto:', productoId);
            window.location.href = `/producto/${productoId}`;
        }

        // Cambiar imagen en el carrusel
        function cambiarImagen(dotElement, imageIndex) {
            const card = dotElement.closest('.producto-card');
            const imagenes = card.querySelectorAll('.producto-image');
            const dots = card.querySelectorAll('.dot');
            
            imagenes.forEach(img => img.classList.remove('active'));
            dots.forEach(dot => dot.classList.remove('active'));
            
            imagenes[imageIndex].classList.add('active');
            dotElement.classList.add('active');
        }

        // Formatear precios
        function formatearPrecio(precio) {
            return precio.toLocaleString('es-CL');
        }

        // Configurar filtros
        function configurarFiltros(productos) {
            const filtros = document.querySelectorAll('.filtro-btn');
            const cards = document.querySelectorAll('.producto-card');
            
            filtros.forEach(filtro => {
                filtro.addEventListener('click', () => {
                    filtros.forEach(f => f.classList.remove('active'));
                    filtro.classList.add('active');
                    
                    const categoria = filtro.dataset.categoria;
                    
                    cards.forEach(card => {
                        if (categoria === 'todas' || card.dataset.categoria === categoria) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            });
        }

        // ===============================================
        // 🛒 SISTEMA DE CARRITO HÍBRIDO COMPLETO
        // ===============================================

        let carritoData = {
            items: [],
            total: 0
        };

        // Generar sessionId único para usuarios anónimos
        function getSessionId() {
            let sessionId = localStorage.getItem('carritoSessionId');
            if (!sessionId) {
                sessionId = 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('carritoSessionId', sessionId);
            }
            return sessionId;
        }

        // Guardar carrito en localStorage
        function guardarCarritoLocal(carrito) {
            localStorage.setItem('carritoData', JSON.stringify(carrito));
        }

        // Cargar carrito desde localStorage
        function cargarCarritoLocal() {
            const datos = localStorage.getItem('carritoData');
            return datos ? JSON.parse(datos) : { items: [], total: 0 };
        }

        // Calcular total del carrito
        function calcularTotal(items) {
            return items.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
        }

        // Actualizar contador visual del carrito
        function actualizarContadorCarrito() {
            const contador = document.getElementById('cartCount');
            const totalItems = carritoData.items.reduce((sum, item) => sum + item.cantidad, 0);
            if (contador) {
                contador.textContent = totalItems;
            }
        }

        // ✅ PASO 1: NUEVA FUNCIÓN actualizarCarritoUI() - REEMPLAZAR LA EXISTENTE
        async function actualizarCarritoUI() {
            const carritoItems = document.getElementById('carritoItems');
            const carritoTotal = document.getElementById('carritoTotal');
            
            if (!carritoItems || !carritoTotal) return;
            
            if (!carritoData || carritoData.items.length === 0) {
                carritoItems.innerHTML = `
                    <div class="carrito-vacio">
                        <i class="fas fa-leaf"></i>
                        <p>Tu carrito está vacío</p>
                        <small>¡Agrega algunas plantas hermosas!</small>
                    </div>
                `;
                carritoTotal.textContent = '0';
                actualizarContadorCarrito();
                return;
            }
            
            // Obtener stock actual de todos los productos en el carrito
            const productosStock = await obtenerStockProductos(carritoData.items.map(item => item.productoId));
            
            carritoItems.innerHTML = carritoData.items.map(item => {
                const stockDisponible = productosStock[item.productoId] || 0;
                const cantidadLimitada = Math.min(item.cantidad, stockDisponible);
                
                // Si la cantidad en el carrito es mayor al stock, actualizar automáticamente
                if (item.cantidad > stockDisponible && stockDisponible > 0) {
                    item.cantidad = stockDisponible;
                }
                
                return `
                    <div class="carrito-item" data-producto-id="${item.productoId}">
                        <div class="item-imagen">
                            <img src="${item.imagen || '/images/default-plant.jpg'}" 
                                 alt="${item.nombre}" 
                                 onerror="this.src='https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=80'">
                        </div>
                        <div class="item-info">
                            <h4>${item.nombre}</h4>
                            <p class="item-precio">$${formatearPrecio(item.precio)} c/u</p>
                            <p class="stock-info ${stockDisponible === 0 ? 'sin-stock' : stockDisponible <= 5 ? 'poco-stock' : ''}">
                                ${stockDisponible === 0 ? '⚠️ Sin stock' : 
                                  stockDisponible <= 5 ? `⚠️ Solo ${stockDisponible} disponibles` : 
                                  `✅ ${stockDisponible} disponibles`}
                            </p>
                        </div>
                        <div class="item-cantidad">
                            <button class="btn-cantidad" onclick="cambiarCantidadCarrito('${item.productoId}', ${item.cantidad - 1}, ${stockDisponible})" 
                                    ${item.cantidad <= 1 || stockDisponible === 0 ? 'disabled' : ''}>-</button>
                            <input type="number" 
                                   class="cantidad-input" 
                                   value="${cantidadLimitada}" 
                                   min="1" 
                                   max="${stockDisponible}"
                                   data-producto-id="${item.productoId}"
                                   data-stock="${stockDisponible}"
                                   onchange="validarYActualizarCantidad(this)"
                                   onblur="validarYActualizarCantidad(this)"
                                   ${stockDisponible === 0 ? 'disabled' : ''}>
                            <button class="btn-cantidad" onclick="cambiarCantidadCarrito('${item.productoId}', ${item.cantidad + 1}, ${stockDisponible})" 
                                    ${item.cantidad >= stockDisponible || stockDisponible === 0 ? 'disabled' : ''}>+</button>
                        </div>
                        <div class="item-subtotal">
                            $${formatearPrecio(item.precio * cantidadLimitada)}
                        </div>
                        <button class="btn-eliminar" onclick="eliminarDelCarrito('${item.productoId}')" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            // Recalcular total con cantidades actualizadas
            carritoData.total = carritoData.items.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
            carritoTotal.textContent = formatearPrecio(carritoData.total);
            actualizarContadorCarrito();
            
            // Guardar cambios si hubo correcciones de stock
            guardarCarritoLocal(carritoData);
        }

        // ✅ FUNCIÓN CORREGIDA: obtenerStockProductos()
        async function obtenerStockProductos(productosIds) {
            try {
                // ✅ USAR LA API QUE SÍ EXISTE
                const response = await fetch('/api/productos');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const productos = await response.json();
                const stockMap = {};
                productos.forEach(producto => {
                    if (productosIds.includes(producto._id)) {
                        stockMap[producto._id] = producto.stock;
                    }
                });
                return stockMap;
            } catch (error) {
                console.error('Error obteniendo stock:', error);
                // Fallback: permitir operación
                const stockMap = {};
                productosIds.forEach(id => {
                    stockMap[id] = 999;
                });
                return stockMap;
            }
        }

        // Función para validar y actualizar cantidad desde input manual
        async function validarYActualizarCantidad(inputElement) {
            const productoId = inputElement.dataset.productoId;
            const stockDisponible = parseInt(inputElement.dataset.stock);
            let nuevaCantidad = parseInt(inputElement.value);
            
            // Validaciones
            if (isNaN(nuevaCantidad) || nuevaCantidad < 1) {
                nuevaCantidad = 1;
            }
            
            if (nuevaCantidad > stockDisponible) {
                nuevaCantidad = stockDisponible;
                mostrarNotificacion(`Solo hay ${stockDisponible} unidades disponibles`, 'warning');
            }
            
            // Actualizar el input con el valor corregido
            inputElement.value = nuevaCantidad;
            
            // Actualizar en el carrito
            await cambiarCantidadCarrito(productoId, nuevaCantidad, stockDisponible, true);
        }

        // ✅ PASO 4: MEJORAR FUNCIÓN cambiarCantidadCarrito() - REEMPLAZAR LA EXISTENTE
        async function cambiarCantidadCarrito(productoId, nuevaCantidad, stockDisponible, esCambioDirecto = false) {
            const item = carritoData.items.find(item => item.productoId === productoId);
            if (!item) return;
            
            // Si no se especifica nueva cantidad, usar la cantidad actual del item
            if (!esCambioDirecto) {
                nuevaCantidad = nuevaCantidad;
            }
            
            // Validaciones
            if (nuevaCantidad <= 0) {
                eliminarDelCarrito(productoId);
                return;
            }
            
            if (nuevaCantidad > stockDisponible) {
                mostrarNotificacion(`Solo hay ${stockDisponible} unidades disponibles`, 'warning');
                nuevaCantidad = stockDisponible;
            }
            
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (!currentUserState?.isLoggedIn) {
                    headers['X-Session-Id'] = getSessionId();
                }
                
                const response = await fetch(`/api/carrito/actualizar/${productoId}`, {
                    method: 'PUT',
                    headers,
                    body: JSON.stringify({ cantidad: nuevaCantidad })
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    carritoData = resultado.carrito;
                    guardarCarritoLocal(carritoData);
                    await actualizarCarritoUI();
                } else {
                    throw new Error('Error en servidor');
                }
                
            } catch (error) {
                console.error('Error actualizando cantidad:', error);
                
                // Fallback: actualizar localmente
                item.cantidad = nuevaCantidad;
                carritoData.total = calcularTotal(carritoData.items);
                guardarCarritoLocal(carritoData);
                await actualizarCarritoUI();
            }
        }

        // ✅ PASO 5: FUNCIÓN cargarCarrito() MEJORADA - REEMPLAZAR LA EXISTENTE
        async function cargarCarrito() {
            try {
                // Primero intentar cargar desde la base de datos
                const headers = {};
                if (!currentUserState?.isLoggedIn) {
                    headers['X-Session-Id'] = getSessionId();
                }
                
                const response = await fetch('/api/carrito', { headers });
                
                if (response.ok) {
                    const carritoServidor = await response.json();
                    if (carritoServidor.items.length > 0) {
                        carritoData = carritoServidor;
                        guardarCarritoLocal(carritoData);
                        
                        // Validar stock después de cargar desde servidor
                        await validarStockCarrito();
                        return;
                    }
                }
                
                // Si no hay datos en el servidor, cargar desde localStorage
                carritoData = cargarCarritoLocal();
                
                // Validar stock del localStorage
                if (carritoData.items.length > 0) {
                    await validarStockCarrito();
                } else {
                    await actualizarCarritoUI();
                }
                
            } catch (error) {
                console.error('Error cargando carrito:', error);
                carritoData = cargarCarritoLocal();
                await actualizarCarritoUI();
            }
        }

        // ✅ NUEVA FUNCIÓN PARA VALIDAR STOCK DEL CARRITO AL CARGAR
        async function validarStockCarrito() {
            if (!carritoData || carritoData.items.length === 0) {
                await actualizarCarritoUI();
                return;
            }
            
            try {
                const productosIds = carritoData.items.map(item => item.productoId);
                const stockMap = await obtenerStockProductos(productosIds);
                
                let huboCambios = false;
                let productosEliminados = [];
                let cantidadesAjustadas = [];
                
                // Revisar cada item del carrito
                carritoData.items = carritoData.items.filter(item => {
                    const stockDisponible = stockMap[item.productoId] || 0;
                    
                    // Si no hay stock, eliminar del carrito
                    if (stockDisponible === 0) {
                        productosEliminados.push(item.nombre);
                        huboCambios = true;
                        return false;
                    }
                    
                    // Si la cantidad excede el stock, ajustar
                    if (item.cantidad > stockDisponible) {
                        cantidadesAjustadas.push({
                            nombre: item.nombre,
                            cantidadAnterior: item.cantidad,
                            cantidadNueva: stockDisponible
                        });
                        item.cantidad = stockDisponible;
                        huboCambios = true;
                    }
                    
                    return true;
                });
                
                if (huboCambios) {
                    // Recalcular total
                    carritoData.total = carritoData.items.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
                    
                    // Guardar cambios
                    guardarCarritoLocal(carritoData);
                    
                    // Mostrar notificaciones sobre los cambios
                    if (productosEliminados.length > 0) {
                        mostrarNotificacion(`❌ Productos eliminados del carrito (sin stock): ${productosEliminados.join(', ')}`, 'warning');
                    }
                    
                    if (cantidadesAjustadas.length > 0) {
                        const mensajes = cantidadesAjustadas.map(item => 
                            `${item.nombre}: ${item.cantidadAnterior} → ${item.cantidadNueva}`
                        );
                        mostrarNotificacion(`⚠️ Cantidades ajustadas por stock limitado:\n${mensajes.join('\n')}`, 'warning');
                    }
                }
                
                await actualizarCarritoUI();
                
            } catch (error) {
                console.error('Error validando stock del carrito:', error);
                await actualizarCarritoUI();
            }
        }

        // ✅ PASO 4: FUNCIÓN agregarAlCarrito() MEJORADA - REEMPLAZAR LA EXISTENTE
        async function agregarAlCarrito(productoId) {
            try {
                console.log('🛒 Agregando al carrito:', productoId);
                
                // Obtener stock actual del producto antes de agregar
                const stockActual = await obtenerStockProductos([productoId]);
                const stockDisponible = stockActual[productoId] || 0;
                
                if (stockDisponible <= 0) {
                    mostrarNotificacion('❌ Este producto está agotado', 'error');
                    return;
                }
                
                // Verificar si ya está en el carrito y validar límite
                const itemExistente = carritoData.items.find(item => item.productoId === productoId);
                if (itemExistente && itemExistente.cantidad >= stockDisponible) {
                    mostrarNotificacion(`⚠️ Ya tienes el máximo disponible (${stockDisponible}) de este producto`, 'warning');
                    return;
                }
                
                const btnElement = event?.target?.closest('.btn-agregar');
                if (btnElement) {
                    const textoOriginal = btnElement.innerHTML;
                    btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Agregando...';
                    btnElement.disabled = true;
                    
                    setTimeout(() => {
                        btnElement.innerHTML = textoOriginal;
                        btnElement.disabled = false;
                    }, 2000);
                }
                
                const headers = { 'Content-Type': 'application/json' };
                if (!currentUserState?.isLoggedIn) {
                    headers['X-Session-Id'] = getSessionId();
                }
                
                const response = await fetch('/api/carrito/agregar', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ 
                        productoId: productoId,
                        cantidad: 1 
                    })
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    carritoData = resultado.carrito;
                    guardarCarritoLocal(carritoData);
                    await actualizarCarritoUI();
                    
                    mostrarNotificacion('¡Producto agregado al carrito! 🌱', 'success');
                } else {
                    const error = await response.json();
                    mostrarNotificacion(error.error || 'Error al agregar producto', 'error');
                }
                
            } catch (error) {
                console.error('Error agregando al carrito:', error);
                
                try {
                    const productosResponse = await fetch('/api/productos');
                    const productos = await productosResponse.json();
                    const producto = productos.find(p => p._id === productoId);
                    
                    if (producto) {
                        const carritoLocal = cargarCarritoLocal();
                        const itemExistente = carritoLocal.items.find(item => item.productoId === productoId);
                        
                        if (itemExistente) {
                            itemExistente.cantidad += 1;
                        } else {
                            carritoLocal.items.push({
                                productoId: producto._id,
                                nombre: producto.nombre,
                                precio: producto.precio,
                                cantidad: 1,
                                imagen: producto.imagenes[0] || ''
                            });
                        }
                        
                        carritoLocal.total = calcularTotal(carritoLocal.items);
                        carritoData = carritoLocal;
                        guardarCarritoLocal(carritoData);
                        await actualizarCarritoUI();
                        
                        mostrarNotificacion('Producto agregado al carrito (modo offline) 📦', 'success');
                    }
                } catch (fallbackError) {
                    mostrarNotificacion('Error al agregar producto al carrito', 'error');
                }
            }
        }

        // Eliminar producto del carrito
        async function eliminarDelCarrito(productoId) {
            try {
                const headers = {};
                if (!currentUserState?.isLoggedIn) {
                    headers['X-Session-Id'] = getSessionId();
                }
                
                const response = await fetch(`/api/carrito/eliminar/${productoId}`, {
                    method: 'DELETE',
                    headers
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    carritoData = resultado.carrito;
                    guardarCarritoLocal(carritoData);
                    await actualizarCarritoUI();
                    mostrarNotificacion('Producto eliminado del carrito', 'info');
                } else {
                    throw new Error('Error en servidor');
                }
                
            } catch (error) {
                console.error('Error eliminando del carrito:', error);
                
                carritoData.items = carritoData.items.filter(item => item.productoId !== productoId);
                carritoData.total = calcularTotal(carritoData.items);
                guardarCarritoLocal(carritoData);
                await actualizarCarritoUI();
                mostrarNotificacion('Producto eliminado del carrito', 'info');
            }
        }

        // Mostrar/ocultar carrito
        function toggleCarrito() {
            const sidebar = document.getElementById('carritoSidebar');
            const overlay = document.getElementById('overlay');
            
            if (!sidebar || !overlay) return;
            
            const isActive = sidebar.classList.contains('active');
            
            if (isActive) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.add('active');
                overlay.classList.add('active');
            }
        }

        // Cargar carrito al inicializar
        async function sincronizarCarrito() {
            if (!currentUserState?.isLoggedIn) return;
            
            try {
                const carritoLocal = cargarCarritoLocal();
                if (carritoLocal.items.length === 0) return;
                
                const response = await fetch('/api/carrito/sincronizar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ items: carritoLocal.items })
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    carritoData = resultado.carrito;
                    guardarCarritoLocal(carritoData);
                    await actualizarCarritoUI();
                    console.log('✅ Carrito sincronizado con servidor');
                }
            } catch (error) {
                console.error('Error sincronizando carrito:', error);
            }
        }

        // ✅ FUNCIÓN PRINCIPAL: procesarCompra() - COMPLETA
        async function procesarCompra() {
            if (carritoData.items.length === 0) {
                mostrarNotificacion('El carrito está vacío', 'warning');
                return;
            }
            
            mostrarModalEntrega();
        }

        // Función para mostrar modal de datos de entrega
        function mostrarModalEntrega() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-checkout">
                    <div class="modal-header">
                        <h3>🚚 Datos de Entrega</h3>
                        <button class="btn-cerrar" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="formEntrega">
                            <div class="form-group">
                                <label for="nombreEntrega">Nombre completo *</label>
                                <input type="text" id="nombreEntrega" name="nombre" required 
                                       placeholder="Tu nombre completo">
                            </div>
                            
                            <div class="form-group">
                                <label for="telefonoEntrega">Teléfono *</label>
                                <input type="tel" id="telefonoEntrega" name="telefono" required 
                                       placeholder="Tu número de teléfono">
                            </div>
                            
                            <div class="form-group">
                                <label for="direccionEntrega">Dirección *</label>
                                <textarea id="direccionEntrega" name="direccion" required 
                                          placeholder="Dirección completa"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="ciudadEntrega">Ciudad *</label>
                                <input type="text" id="ciudadEntrega" name="ciudad" required 
                                       placeholder="Tu ciudad">
                            </div>
                            
                            <div class="form-group">
                                <label for="codigoPostal">Código Postal</label>
                                <input type="text" id="codigoPostal" name="codigoPostal" 
                                       placeholder="Código postal (opcional)">
                            </div>
                            
                            <div class="form-group">
                                <label for="metodoPago">Método de Pago *</label>
                                <select id="metodoPago" name="metodoPago" required>
                                    <option value="efectivo">Efectivo contra entrega</option>
                                    <option value="transferencia">Transferencia bancaria</option>
                                    <option value="tarjeta">Tarjeta de crédito/débito</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="notasEntrega">Notas adicionales</label>
                                <textarea id="notasEntrega" name="notas" 
                                          placeholder="Instrucciones especiales (opcional)"></textarea>
                            </div>
                            
                            <div class="resumen-pedido">
                                <h4>📋 Resumen del Pedido</h4>
                                <div class="items-resumen">
                                    ${carritoData.items.map(item => `
                                        <div class="item-resumen">
                                            <span>${item.nombre} x${item.cantidad}</span>
                                            <span>$${formatearPrecio(item.precio * item.cantidad)}</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="total-resumen">
                                    <strong>Total: $${formatearPrecio(carritoData.total)}</strong>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secundario" 
                                onclick="this.closest('.modal-overlay').remove()">
                            Cancelar
                        </button>
                        <button type="button" class="btn-primario" 
                                onclick="confirmarPedido()" id="btnConfirmarPedido">
                            Confirmar Pedido 🛍️
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            setTimeout(() => {
                document.getElementById('nombreEntrega').focus();
            }, 100);
        }

        // Función para confirmar el pedido
        async function confirmarPedido() {
            const form = document.getElementById('formEntrega');
            const btnConfirmar = document.getElementById('btnConfirmarPedido');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = new FormData(form);
            const datosEntrega = {
                nombre: formData.get('nombre').trim(),
                telefono: formData.get('telefono').trim(),
                direccion: formData.get('direccion').trim(),
                ciudad: formData.get('ciudad').trim(),
                codigoPostal: formData.get('codigoPostal')?.trim() || '',
                notas: formData.get('notas')?.trim() || ''
            };
            
            const metodoPago = formData.get('metodoPago');
            
            if (!datosEntrega.nombre || !datosEntrega.telefono || !datosEntrega.direccion || !datosEntrega.ciudad) {
                mostrarNotificacion('Por favor completa todos los campos obligatorios', 'error');
                return;
            }
            
            try {
                btnConfirmar.disabled = true;
                btnConfirmar.textContent = 'Procesando... ⏳';
                
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (!currentUserState?.isLoggedIn) {
                    headers['X-Session-Id'] = getSessionId();
                }
                
                const response = await fetch('/api/pedidos/procesar', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        datosEntrega: datosEntrega,
                        metodoPago: metodoPago
                    })
                });
                
                const resultado = await response.json();
                
                if (response.ok && resultado.success) {
                    carritoData = { items: [], total: 0 };
                    guardarCarritoLocal(carritoData);
                    await actualizarCarritoUI();
                    
                    document.querySelector('.modal-overlay').remove();
                    
                    mostrarModalExito(resultado.pedido);
                    
                } else {
                    throw new Error(resultado.error || 'Error procesando el pedido');
                }
                
            } catch (error) {
                console.error('Error procesando pedido:', error);
                mostrarNotificacion(error.message || 'Error procesando el pedido. Intenta nuevamente.', 'error');
                
            } finally {
                btnConfirmar.disabled = false;
                btnConfirmar.textContent = 'Confirmar Pedido 🛍️';
            }
        }

        // Función para mostrar modal de éxito
        function mostrarModalExito(pedido) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-exito">
                    <div class="modal-header">
                        <h3>🎉 ¡Pedido Confirmado!</h3>
                    </div>
                    <div class="modal-body">
                        <div class="mensaje-exito">
                            <div class="icono-exito">✅</div>
                            <h4>Tu pedido ha sido procesado exitosamente</h4>
                            <div class="detalles-pedido">
                                <p><strong>Número de pedido:</strong> ${pedido.numeroPedido}</p>
                                <p><strong>Total:</strong> $${formatearPrecio(pedido.total)}</p>
                                <p><strong>Estado:</strong> ${pedido.estado}</p>
                                <p><strong>Fecha:</strong> ${new Date(pedido.fechaPedido).toLocaleDateString('es-ES')}</p>
                            </div>
                            <div class="info-entrega">
                                <p>📞 Te contactaremos pronto para coordinar la entrega</p>
                                <p>📧 Recibirás un email con los detalles del pedido</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-primario" 
                                onclick="this.closest('.modal-overlay').remove(); location.reload();">
                            Continuar Comprando 🛍️
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Función para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notif = document.createElement('div');
            notif.className = `notificacion ${tipo}`;
            notif.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${mensaje}
            `;
            
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                max-width: 400px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                ${tipo === 'success' ? 'background: #27ae60;' : ''}
                ${tipo === 'error' ? 'background: #e74c3c;' : ''}
                ${tipo === 'warning' ? 'background: #f39c12;' : ''}
                ${tipo === 'info' ? 'background: #3498db;' : ''}
            `;
            
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notif)) {
                        document.body.removeChild(notif);
                    }
                }, 300);
            }, 4000);
        }

        // Ejecutar cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Página cargada, inicializando...');
            updateUserButtons();
            cargarProductos();
            cargarBannerDinamico();
            cargarCarrito();
            
            setInterval(updateUserButtons, 30000);
        });

        // Sincronizar carrito cuando cambie el estado del usuario
        const originalUpdateUserButtons = updateUserButtons;
        updateUserButtons = async function() {
            const estadoAnterior = currentUserState?.isLoggedIn;
            await originalUpdateUserButtons();
            const estadoActual = currentUserState?.isLoggedIn;
            
            if (!estadoAnterior && estadoActual) {
                console.log('🔄 Usuario logueado, sincronizando carrito...');
                await sincronizarCarrito();
            }
        };

        // Exponer funciones de debug globalmente
        window.checkUserState = checkUserState;
        window.updateUserButtons = updateUserButtons;
    </script>
</body>
</html>