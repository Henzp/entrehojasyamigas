<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå± Entre Hojas y Amigas - Plantas de interior y exterior a domicilio</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/index.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&family=Great+Vibes&family=Satisfy&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <!-- Logo Section -->
        <div class="logo-section">
            <div class="container">
                <div class="logo-container">
                    <div class="logo">
                        <img src="/images/logo-entre-hojas-amigas.png" alt="Entre Hojas y Amigas" class="logo-img">
                        <h1>üåø Entre Hojas y Amigas</h1>
                    </div>
                    
                    <div class="nav-actions">
                        <button class="search-btn"><i class="fas fa-search"></i></button>
                        <button class="cart-btn" onclick="toggleCarrito()">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="cart-count" id="cartCount">0</span>
                        </button>
                        
                        <div id="userActions" class="user-actions-container">
                            <span class="loading-user">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation Section -->
        <nav class="navbar">
            <div class="container">
                <ul class="nav-menu">
                    <li><a href="#inicio">Inicio</a></li>
                    <li class="dropdown">
                        <a href="#productos">Plantas <i class="fas fa-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="#" data-categoria="Interior">Interior</a></li>
                            <li><a href="#" data-categoria="Exterior">Exterior</a></li>
                            <li><a href="#" data-categoria="Pet Friendly">Pet Friendly</a></li>
                            <li><a href="#" data-categoria="F√°cil Cuidado">F√°cil Cuidado</a></li>
                        </ul>
                    </li>
                    <li><a href="#maceteros">Maceteros</a></li>
                    <li><a href="#regalos">Regalos</a></li>
                    <li><a href="/tips">Tips</a></li>
                    <li><a href="#contacto">Contacto</a></li>
                </ul>
                
                <div class="hamburger">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="hero" id="inicio">
        <div class="hero-content">
            <h1>Plantas de interior y exterior a domicilio</h1>
            <p>Encuentra una gran variedad de plantas de interior y exterior a domicilio. Entregamos en toda la regi√≥n metropolitana con el mejor cuidado y atenci√≥n personalizada.</p>
            <div class="hero-buttons">
                <a href="#productos" class="btn-primary">
                    <i class="fas fa-seedling"></i> Ver Plantas
                </a>
                <a href="/tips" class="btn-secondary">
                    <i class="fas fa-lightbulb"></i> Tips de Cuidado
                </a>
            </div>
        </div>
    </section>

    <!-- Secci√≥n de Categor√≠as -->
    <section class="categorias">
        <div class="container">
            <h2>Nuestras Categor√≠as</h2>
            <div class="categorias-grid">
                <a href="#" class="categoria-card" data-categoria="Interior">
                    <div class="categoria-imagen" style="background-image: url('https://images.unsplash.com/photo-1586880244406-556ebe35f282?w=500')"></div>
                    <div class="categoria-info">
                        <h3>Plantas de Interior</h3>
                        <p>Perfectas para decorar tu hogar con vida y color</p>
                    </div>
                </a>
                
                <a href="#" class="categoria-card" data-categoria="Exterior">
                    <div class="categoria-imagen" style="background-image: url('https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=500')"></div>
                    <div class="categoria-info">
                        <h3>Plantas de Exterior</h3>
                        <p>Ideales para jardines, terrazas y patios</p>
                    </div>
                </a>
                
                <a href="#" class="categoria-card" data-categoria="Pet Friendly">
                    <div class="categoria-imagen" style="background-image: url('https://images.unsplash.com/photo-1463154545680-d59320fd685d?w=500')"></div>
                    <div class="categoria-info">
                        <h3>Pet Friendly</h3>
                        <p>Seguras para tus mascotas queridas</p>
                    </div>
                </a>
                
                <a href="#" class="categoria-card" data-categoria="F√°cil Cuidado">
                    <div class="categoria-imagen" style="background-image: url('https://images.unsplash.com/photo-1485955900006-10f4d324d411?w=500')"></div>
                    <div class="categoria-info">
                        <h3>F√°cil Cuidado</h3>
                        <p>Perfectas para principiantes</p>
                    </div>
                </a>
            </div>
        </div>
    </section>

    <!-- Secci√≥n de Productos -->
    <section class="productos" id="productos">
        <div class="container">
            <h2>Nuestras Plantas</h2>
            
            <!-- Filtros de categor√≠a -->
            <div class="filtros-categoria">
                <button class="filtro-btn active" data-categoria="todos">
                    <i class="fas fa-th"></i> Todas
                </button>
                <button class="filtro-btn" data-categoria="Interior">
                    <i class="fas fa-home"></i> Interior
                </button>
                <button class="filtro-btn" data-categoria="Exterior">
                    <i class="fas fa-tree"></i> Exterior
                </button>
                <button class="filtro-btn" data-categoria="Pet Friendly">
                    <i class="fas fa-paw"></i> Pet Friendly
                </button>
                <button class="filtro-btn" data-categoria="F√°cil Cuidado">
                    <i class="fas fa-seedling"></i> F√°cil Cuidado
                </button>
            </div>
            
            <div class="productos-grid" id="productosGrid">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Cargando plantas...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Misi√≥n -->
    <section class="mision">
        <div class="container">
            <div class="mision-content">
                <h2>Compartiendo una conexi√≥n especial con la naturaleza, entregando alegr√≠a, pero en macetas</h2>
            </div>
        </div>
    </section>

    <!-- Banner de Im√°genes Animado (Din√°mico) -->
    <section class="banner-imagenes" id="bannerSection" style="display: none;">
        <div class="banner-container">
            <div class="banner-track" id="bannerTrack">
                <!-- Las im√°genes se cargar√°n din√°micamente -->
            </div>
        </div>
    </section>

    <!-- Secci√≥n de Caracter√≠sticas -->
    <section class="caracteristicas">
        <div class="container">
            <h2>¬øPor qu√© elegirnos?</h2>
            <div class="caracteristicas-grid">
                <div class="caracteristica-item">
                    <div class="caracteristica-icon">
                        <i class="fas fa-truck"></i>
                    </div>
                    <h3>Entrega a Domicilio</h3>
                    <p>Llevamos tus plantas favoritas directamente a tu puerta con el mejor cuidado.</p>
                </div>
                
                <div class="caracteristica-item">
                    <div class="caracteristica-icon">
                        <i class="fas fa-heart"></i>
                    </div>
                    <h3>Plantas Saludables</h3>
                    <p>Cada planta es cuidadosamente seleccionada para garantizar su salud y belleza.</p>
                </div>
                
                <div class="caracteristica-item">
                    <div class="caracteristica-icon">
                        <i class="fas fa-user-friends"></i>
                    </div>
                    <h3>Asesor√≠a Personalizada</h3>
                    <p>Te ayudamos a elegir las plantas perfectas para tu espacio y estilo de vida.</p>
                </div>
                
                <div class="caracteristica-item">
                    <div class="caracteristica-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3>Garant√≠a de Calidad</h3>
                    <p>Ofrecemos garant√≠a en todas nuestras plantas para tu completa tranquilidad.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Carrito Sidebar -->
    <div class="carrito-sidebar" id="carritoSidebar">
        <div class="carrito-header">
            <h3><i class="fas fa-shopping-cart"></i> Mi Carrito</h3>
            <button class="close-carrito" onclick="toggleCarrito()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="carrito-items" id="carritoItems">
            <div class="carrito-vacio">
                <i class="fas fa-leaf"></i>
                <p>Tu carrito est√° vac√≠o</p>
                <small>¬°Agrega algunas plantas hermosas!</small>
            </div>
        </div>
        <div class="carrito-footer">
            <div class="carrito-total">
                <strong>Total: $<span id="carritoTotal">0</span></strong>
            </div>
            <button class="btn-comprar-carrito" onclick="procesarCompra()">
                <i class="fas fa-credit-card"></i> Procesar Compra
            </button>
        </div>
    </div>

    <!-- Modal para ampliar imagen de producto -->
    <div class="modal-imagen" id="modalImagen" onclick="cerrarModal()">
        <div class="modal-contenido">
            <span class="modal-cerrar">&times;</span>
            <img id="imagenModal" src="" alt="">
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer" id="contacto">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>üåø Entre Hojas y Amigas</h3>
                    <p>Tu tienda de confianza para plantas de interior y exterior.</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-whatsapp"></i></a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Navegaci√≥n</h4>
                    <ul>
                        <li><a href="#inicio">Inicio</a></li>
                        <li><a href="#productos">Plantas</a></li>
                        <li><a href="/tips">Tips de Cuidado</a></li>
                        <li><a href="#contacto">Contacto</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Categor√≠as</h4>
                    <ul>
                        <li><a href="#" data-categoria="Interior">Plantas de Interior</a></li>
                        <li><a href="#" data-categoria="Exterior">Plantas de Exterior</a></li>
                        <li><a href="#" data-categoria="Pet Friendly">Pet Friendly</a></li>
                        <li><a href="#" data-categoria="F√°cil Cuidado">F√°cil Cuidado</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Contacto</h4>
                    <div class="contact-info">
                        <p><i class="fas fa-phone"></i> +56 9 1234 5678</p>
                        <p><i class="fas fa-envelope"></i> info@entrehojasyamigas.cl</p>
                        <p><i class="fas fa-map-marker-alt"></i> Santiago, Chile</p>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 Entre Hojas y Amigas. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // ‚úÖ VARIABLES GLOBALES
        let productosData = [];
        let carritoData = { items: [], total: 0 };
        let currentUserState = { isLoggedIn: false, userData: null };

        // ‚úÖ FUNCI√ìN: obtenerSessionId()
        function getSessionId() {
            let sessionId = localStorage.getItem('guest_session_id');
            if (!sessionId) {
                sessionId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('guest_session_id', sessionId);
            }
            return sessionId;
        }

        // ‚úÖ FUNCI√ìN: verificarSesion()
        async function verificarSesion() {
            try {
                const response = await fetch('/api/auth/verificar', {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUserState = {
                        isLoggedIn: true,
                        userData: data.usuario
                    };
                    console.log('‚úÖ Usuario logueado:', data.usuario);
                } else {
                    currentUserState = { isLoggedIn: false, userData: null };
                    console.log('‚ÑπÔ∏è Usuario no logueado');
                }
            } catch (error) {
                console.error('Error verificando sesi√≥n:', error);
                currentUserState = { isLoggedIn: false, userData: null };
            }
        }

        // ‚úÖ FUNCI√ìN: actualizarUserActions()
        function actualizarUserActions() {
            const userActionsContainer = document.getElementById('userActions');
            
            if (currentUserState.isLoggedIn) {
                const userData = currentUserState.userData;
                userActionsContainer.innerHTML = `
                    <div class="user-menu">
                        <span class="user-greeting">¬°Hola, ${userData.nombre}!</span>
                        <div class="user-dropdown">
                            <button class="user-btn">
                                <i class="fas fa-user"></i>
                                <span>${userData.nombre}</span>
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="dropdown-content">
                                <a href="/perfil"><i class="fas fa-user"></i> Mi Perfil</a>
                                ${userData.isAdmin ? '<a href="/admin"><i class="fas fa-cogs"></i> Admin Panel</a>' : ''}
                                <a href="#" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</a>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                userActionsContainer.innerHTML = `
                    <div class="auth-buttons">
                        <a href="/login" class="btn-login">
                            <i class="fas fa-sign-in-alt"></i> Iniciar Sesi√≥n
                        </a>
                        <a href="/register" class="btn-register">
                            <i class="fas fa-user-plus"></i> Registrarse
                        </a>
                    </div>
                `;
            }
        }

        // ‚úÖ FUNCI√ìN: cerrarSesion()
        async function cerrarSesion() {
            try {
                await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
                currentUserState = { isLoggedIn: false, userData: null };
                carritoData = { items: [], total: 0 };
                localStorage.removeItem('carrito');
                actualizarUserActions();
                await actualizarCarritoUI();
                mostrarNotificacion('Sesi√≥n cerrada correctamente', 'success');
            } catch (error) {
                console.error('Error cerrando sesi√≥n:', error);
                mostrarNotificacion('Error cerrando sesi√≥n', 'error');
            }
        }

        // ‚úÖ FUNCI√ìN: cargarProductos()
        async function cargarProductos() {
            try {
                console.log('üîÑ Cargando productos...');
                const response = await fetch('/api/productos');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                productosData = await response.json();
                console.log('‚úÖ Productos cargados:', productosData.length);
                
                if (productosData && productosData.length > 0) {
                    mostrarProductos(productosData);
                } else {
                    document.getElementById('productosGrid').innerHTML = `
                        <div class="no-productos">
                            <i class="fas fa-seedling"></i>
                            <p>No hay productos disponibles en este momento</p>
                            <small>¬°Pronto tendremos nuevas plantas para ti!</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error cargando productos:', error);
                document.getElementById('productosGrid').innerHTML = `
                    <div class="error-productos">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Error cargando productos</p>
                        <button onclick="cargarProductos()" class="btn-retry">
                            <i class="fas fa-redo"></i> Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // ‚úÖ FUNCI√ìN: mostrarProductos()
        function mostrarProductos(productos) {
            const productosGrid = document.getElementById('productosGrid');
            
            if (!productos || productos.length === 0) {
                productosGrid.innerHTML = `
                    <div class="no-productos">
                        <i class="fas fa-seedling"></i>
                        <p>No se encontraron productos</p>
                    </div>
                `;
                return;
            }

            productosGrid.innerHTML = productos.map(producto => {
                const imagenes = producto.imagenes || [];
                const precioOriginal = producto.precioOriginal || null;
                const categoria = producto.categoria || '';
                
                return `
                    <div class="producto-card" data-categoria="${categoria}">
                        <div class="producto-images" onclick="verDetalleProducto('${producto._id}')">
                            ${imagenes.length > 0 ? imagenes.map((imagen, index) => `
                                <img src="${imagen}" 
                                     alt="${producto.nombre}" 
                                     class="producto-image ${index === 0 ? 'active' : ''}"
                                     onerror="this.src='https://via.placeholder.com/300x280/f8f9fa/6c757d?text=Imagen+no+disponible'"
                                     loading="lazy">
                            `).join('') : `
                                <img src="https://via.placeholder.com/300x280/f8f9fa/6c757d?text=Sin+imagen" 
                                     alt="${producto.nombre}" 
                                     class="producto-image active">
                            `}
                            
                            <div class="categoria-badge">${categoria}</div>
                            
                            ${imagenes.length > 1 ? `
                                <div class="image-dots">
                                    ${imagenes.map((_, index) => `
                                        <span class="dot ${index === 0 ? 'active' : ''}" 
                                              onclick="event.stopPropagation(); cambiarImagenProducto(event, ${index})"></span>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="producto-info">
                            <div class="producto-content">
                                <h3 class="producto-nombre">${producto.nombre}</h3>
                                <div class="producto-precio">
                                    ${precioOriginal ? `<span class="precio-original">$${precioOriginal.toLocaleString()}</span>` : ''}
                                    $${producto.precio.toLocaleString()}
                                </div>
                                <p class="producto-descripcion">${producto.descripcion || 'Hermosa planta perfecta para tu hogar'}</p>
                            </div>
                            
                            <div class="producto-actions">
                                <button class="btn-comprar" onclick="agregarAlCarrito('${producto._id}')">
                                    <i class="fas fa-shopping-cart"></i> Agregar
                                </button>
                                <button class="btn-ver-detalles" onclick="verDetalleProducto('${producto._id}')">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Inicializar rotaci√≥n de im√°genes
            inicializarRotacionImagenes();
        }

        // ‚úÖ FUNCI√ìN: cambiarImagenProducto()
        function cambiarImagenProducto(event, index) {
            event.preventDefault();
            event.stopPropagation();
            
            const card = event.target.closest('.producto-card');
            const imagenes = card.querySelectorAll('.producto-image');
            const dots = card.querySelectorAll('.dot');
            
            imagenes.forEach((img, i) => {
                img.classList.toggle('active', i === index);
            });
            
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }

        // ‚úÖ FUNCI√ìN: inicializarRotacionImagenes()
        function inicializarRotacionImagenes() {
            const cards = document.querySelectorAll('.producto-card');
            
            cards.forEach(card => {
                const imagenes = card.querySelectorAll('.producto-image');
                
                if (imagenes.length > 1) {
                    let currentIndex = 0;
                    
                    setInterval(() => {
                        imagenes[currentIndex].classList.remove('active');
                        const dots = card.querySelectorAll('.dot');
                        if (dots.length > 0) {
                            dots[currentIndex].classList.remove('active');
                        }
                        
                        currentIndex = (currentIndex + 1) % imagenes.length;
                        
                        imagenes[currentIndex].classList.add('active');
                        if (dots.length > 0) {
                            dots[currentIndex].classList.add('active');
                        }
                    }, 4000); // Cambiar cada 4 segundos
                }
            });
        }

        // ‚úÖ FUNCI√ìN: verDetalleProducto()
        function verDetalleProducto(productoId) {
            window.location.href = `/producto/${productoId}`;
        }

        // ‚úÖ FUNCI√ìN: agregarAlCarrito()
        async function agregarAlCarrito(productoId) {
            const producto = productosData.find(p => p._id === productoId);
            if (!producto) {
                mostrarNotificacion('Producto no encontrado', 'error');
                return;
            }

            const itemExistente = carritoData.items.find(item => item.productoId === productoId);
            
            if (itemExistente) {
                itemExistente.cantidad += 1;
                itemExistente.subtotal = itemExistente.cantidad * itemExistente.precio;
            } else {
                carritoData.items.push({
                    productoId: productoId,
                    nombre: producto.nombre,
                    precio: producto.precio,
                    imagen: producto.imagenes && producto.imagenes.length > 0 ? producto.imagenes[0] : 'https://via.placeholder.com/60x60',
                    cantidad: 1,
                    subtotal: producto.precio
                });
            }

            await actualizarCarritoUI();
            guardarCarritoLocal(carritoData);
            mostrarNotificacion(`${producto.nombre} agregado al carrito`, 'success');
        }

        // ‚úÖ FUNCI√ìN: actualizarCarritoUI()
        async function actualizarCarritoUI() {
            const cartCount = document.getElementById('cartCount');
            const carritoItems = document.getElementById('carritoItems');
            const carritoTotal = document.getElementById('carritoTotal');
            
            const totalItems = carritoData.items.reduce((sum, item) => sum + item.cantidad, 0);
            const totalPrecio = carritoData.items.reduce((sum, item) => sum + item.subtotal, 0);
            
            cartCount.textContent = totalItems;
            carritoTotal.textContent = totalPrecio.toLocaleString();
            
            if (carritoData.items.length === 0) {
                carritoItems.innerHTML = `
                    <div class="carrito-vacio">
                        <i class="fas fa-leaf"></i>
                        <p>Tu carrito est√° vac√≠o</p>
                        <small>¬°Agrega algunas plantas hermosas!</small>
                    </div>
                `;
            } else {
                carritoItems.innerHTML = carritoData.items.map(item => `
                    <div class="carrito-item">
                        <img src="${item.imagen}" alt="${item.nombre}" onerror="this.src='https://via.placeholder.com/60x60/f8f9fa/6c757d?text=Sin+imagen'">
                        <div class="item-info">
                            <h4>${item.nombre}</h4>
                            <div class="item-cantidad">
                                <button onclick="cambiarCantidad('${item.productoId}', -1)">-</button>
                                <span>${item.cantidad}</span>
                                <button onclick="cambiarCantidad('${item.productoId}', 1)">+</button>
                            </div>
                        </div>
                        <div class="item-precio">
                            $${item.subtotal.toLocaleString()}
                            <button onclick="eliminarDelCarrito('${item.productoId}')" class="btn-eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // ‚úÖ FUNCI√ìN: cambiarCantidad()
        function cambiarCantidad(productoId, cambio) {
            const item = carritoData.items.find(item => item.productoId === productoId);
            if (!item) return;

            item.cantidad += cambio;
            
            if (item.cantidad <= 0) {
                eliminarDelCarrito(productoId);
                return;
            }
            
            item.subtotal = item.cantidad * item.precio;
            actualizarCarritoUI();
            guardarCarritoLocal(carritoData);
        }

        // ‚úÖ FUNCI√ìN: eliminarDelCarrito()
        function eliminarDelCarrito(productoId) {
            carritoData.items = carritoData.items.filter(item => item.productoId !== productoId);
            actualizarCarritoUI();
            guardarCarritoLocal(carritoData);
            mostrarNotificacion('Producto eliminado del carrito', 'info');
        }

        // ‚úÖ FUNCI√ìN: toggleCarrito()
        function toggleCarrito() {
            const carritoSidebar = document.getElementById('carritoSidebar');
            carritoSidebar.classList.toggle('activo');
        }

        // ‚úÖ FUNCI√ìN: guardarCarritoLocal()
        function guardarCarritoLocal(carrito) {
            localStorage.setItem('carrito', JSON.stringify(carrito));
        }

        // ‚úÖ FUNCI√ìN: cargarCarritoLocal()
        function cargarCarritoLocal() {
            const carritoGuardado = localStorage.getItem('carrito');
            if (carritoGuardado) {
                try {
                    carritoData = JSON.parse(carritoGuardado);
                } catch (error) {
                    console.error('Error parseando carrito local:', error);
                    carritoData = { items: [], total: 0 };
                }
            }
        }

        // ‚úÖ FUNCI√ìN: procesarCompra()
        async function procesarCompra() {
            if (carritoData.items.length === 0) {
                mostrarNotificacion('El carrito est√° vac√≠o', 'warning');
                return;
            }
            
            mostrarModalEntrega();
        }

        // ‚úÖ FUNCI√ìN: mostrarModalEntrega()
        function mostrarModalEntrega() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-checkout">
                    <div class="modal-header">
                        <h3>üöö Datos de Entrega</h3>
                        <button class="btn-cerrar" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <form id="formEntrega">
                            <div class="form-group">
                                <label for="nombreEntrega">Nombre completo *</label>
                                <input type="text" id="nombreEntrega" name="nombre" required 
                                       placeholder="Tu nombre completo">
                            </div>
                            
                            <div class="form-group">
                                <label for="telefonoEntrega">Tel√©fono *</label>
                                <input type="tel" id="telefonoEntrega" name="telefono" required 
                                       placeholder="+56 9 1234 5678">
                            </div>
                            
                            <div class="form-group">
                                <label for="direccionEntrega">Direcci√≥n completa *</label>
                                <textarea id="direccionEntrega" name="direccion" required 
                                          placeholder="Calle, n√∫mero, departamento, referencias"></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="ciudadEntrega">Ciudad *</label>
                                    <input type="text" id="ciudadEntrega" name="ciudad" required 
                                           placeholder="Santiago">
                                </div>
                                
                                <div class="form-group">
                                    <label for="codigoPostal">C√≥digo Postal</label>
                                    <input type="text" id="codigoPostal" name="codigoPostal" 
                                           placeholder="1234567">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="notasEntrega">Notas adicionales</label>
                                <textarea id="notasEntrega" name="notas" 
                                          placeholder="Instrucciones especiales de entrega"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>M√©todo de Pago *</label>
                                <div class="payment-options">
                                    <label class="payment-option">
                                        <input type="radio" name="metodoPago" value="efectivo" checked>
                                        <span>üíµ Efectivo contra entrega</span>
                                    </label>
                                    <label class="payment-option">
                                        <input type="radio" name="metodoPago" value="transferencia">
                                        <span>üè¶ Transferencia bancaria</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="modal-footer">
                                <div class="resumen-compra">
                                    <h4>Resumen del Pedido:</h4>
                                    <div class="items-resumen">
                                        ${carritoData.items.map(item => `
                                            <div class="item-resumen">
                                                <span>${item.nombre} x${item.cantidad}</span>
                                                <span>$${item.subtotal.toLocaleString()}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="total-resumen">
                                        <strong>Total: $${carritoData.items.reduce((sum, item) => sum + item.subtotal, 0).toLocaleString()}</strong>
                                    </div>
                                </div>
                                
                                <div class="form-buttons">
                                    <button type="button" class="btn-cancelar" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
                                    <button type="submit" class="btn-confirmar">Confirmar Pedido</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Manejar env√≠o del formulario
            document.getElementById('formEntrega').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const btnConfirmar = e.target.querySelector('.btn-confirmar');
                
                const datosEntrega = {
                    nombre: formData.get('nombre').trim(),
                    telefono: formData.get('telefono').trim(),
                    direccion: formData.get('direccion').trim(),
                    ciudad: formData.get('ciudad').trim(),
                    codigoPostal: formData.get('codigoPostal')?.trim() || '',
                    notas: formData.get('notas')?.trim() || ''
                };
                
                const metodoPago = formData.get('metodoPago');
                
                if (!datosEntrega.nombre || !datosEntrega.telefono || !datosEntrega.direccion || !datosEntrega.ciudad) {
                    mostrarNotificacion('Por favor completa todos los campos obligatorios', 'error');
                    return;
                }
                
                try {
                    btnConfirmar.disabled = true;
                    btnConfirmar.textContent = 'Procesando... ‚è≥';
                    
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    if (!currentUserState?.isLoggedIn) {
                        headers['X-Session-Id'] = getSessionId();
                    }
                    
                    const response = await fetch('/api/pedidos/procesar', {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify({
                            datosEntrega: datosEntrega,
                            metodoPago: metodoPago
                        })
                    });
                    
                    const resultado = await response.json();
                    
                    if (response.ok && resultado.success) {
                        carritoData = { items: [], total: 0 };
                        guardarCarritoLocal(carritoData);
                        await actualizarCarritoUI();
                        
                        document.querySelector('.modal-overlay').remove();
                        
                        mostrarModalExito(resultado.pedido);
                        
                    } else {
                        throw new Error(resultado.error || 'Error procesando el pedido');
                    }
                    
                } catch (error) {
                    console.error('Error procesando pedido:', error);
                    mostrarNotificacion(error.message || 'Error procesando el pedido. Intenta nuevamente.', 'error');
                    btnConfirmar.disabled = false;
                    btnConfirmar.textContent = 'Confirmar Pedido';
                }
            });
        }

        // ‚úÖ FUNCI√ìN: mostrarModalExito()
        function mostrarModalExito(pedido) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-exito">
                    <div class="modal-header">
                        <h3>üéâ ¬°Pedido Exitoso!</h3>
                    </div>
                    <div class="modal-body">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4>Tu pedido ha sido procesado correctamente</h4>
                        <p><strong>N√∫mero de pedido:</strong> #${pedido.numeroPedido}</p>
                        <p><strong>Total:</strong> $${pedido.total.toLocaleString()}</p>
                        <p><strong>M√©todo de pago:</strong> ${pedido.metodoPago === 'efectivo' ? 'Efectivo contra entrega' : 'Transferencia bancaria'}</p>
                        
                        <div class="info-entrega">
                            <h5>üìç Datos de entrega:</h5>
                            <p>${pedido.datosEntrega.nombre}</p>
                            <p>${pedido.datosEntrega.telefono}</p>
                            <p>${pedido.datosEntrega.direccion}, ${pedido.datosEntrega.ciudad}</p>
                        </div>
                        
                        <p class="contact-info">
                            <strong>üìû Nos contactaremos contigo pronto para coordinar la entrega.</strong>
                        </p>
                        
                        <button class="btn-continuar" onclick="this.closest('.modal-overlay').remove()">
                            Continuar Comprando
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ‚úÖ FUNCI√ìN: mostrarNotificacion()
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="${icons[tipo]}"></i>
                <span>${mensaje}</span>
                <button onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // ‚úÖ FUNCI√ìN: filtrarPorCategoria()
        function filtrarPorCategoria(categoria) {
            // Actualizar botones activos
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Filtrar productos
            const productos = categoria === 'todos' ? productosData : productosData.filter(p => p.categoria === categoria);
            mostrarProductos(productos);
        }

        // ‚úÖ FUNCI√ìN: cerrarModal()
        function cerrarModal() {
            const modal = document.getElementById('modalImagen');
            modal.style.display = 'none';
        }

        // ‚úÖ FUNCI√ìN: cargarBanners()
        async function cargarBanners() {
            try {
                const response = await fetch('/api/banners');
                if (response.ok) {
                    const banners = await response.json();
                    if (banners && banners.length > 0) {
                        mostrarBanner(banners);
                    }
                }
            } catch (error) {
                console.error('Error cargando banners:', error);
            }
        }

        // ‚úÖ FUNCI√ìN: mostrarBanner()
        function mostrarBanner(banners) {
            const bannerSection = document.getElementById('bannerSection');
            const bannerTrack = document.getElementById('bannerTrack');
            
            if (!banners || banners.length === 0) return;
            
            // Duplicar banners para animaci√≥n continua
            const bannersDobles = [...banners, ...banners];
            
            bannerTrack.innerHTML = bannersDobles.map(banner => `
                <div class="banner-item">
                    <img src="${banner.imagen}" alt="${banner.alt || 'Banner'}" loading="lazy">
                </div>
            `).join('');
            
            bannerSection.style.display = 'block';
        }

        // ‚úÖ EVENT LISTENERS
        document.addEventListener('DOMContentLoaded', async function() {
            await verificarSesion();
            actualizarUserActions();
            cargarCarritoLocal();
            await actualizarCarritoUI();
            await cargarProductos();
            await cargarBanners();
            
            // Event listeners para filtros de categor√≠a
            document.querySelectorAll('[data-categoria]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const categoria = e.target.getAttribute('data-categoria');
                    filtrarPorCategoria(categoria);
                    
                    // Scroll a productos
                    document.getElementById('productos').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                });
            });

            // Event listeners para filtros de botones
            document.querySelectorAll('.filtro-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoria = e.target.getAttribute('data-categoria');
                    filtrarPorCategoria(categoria);
                });
            });
            
            // Hamburger menu
            const hamburger = document.querySelector('.hamburger');
            const navMenu = document.querySelector('.nav-menu');
            
            if (hamburger && navMenu) {
                hamburger.addEventListener('click', () => {
                    hamburger.classList.toggle('active');
                    navMenu.classList.toggle('active');
                });
            }
            
            // Cerrar carrito al hacer clic fuera
            document.addEventListener('click', (e) => {
                const carritoSidebar = document.getElementById('carritoSidebar');
                const cartBtn = document.querySelector('.cart-btn');
                
                if (!carritoSidebar.contains(e.target) && !cartBtn.contains(e.target)) {
                    carritoSidebar.classList.remove('activo');
                }
            });

            // Smooth scroll para enlaces internos
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth'
                        });
                    }
                });
            });
        });
    </script>
</body>
</html>